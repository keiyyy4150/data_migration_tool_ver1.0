ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ã®

keyColIdx(kc) = FindColumnIndex(arr, Map_SrcCols(i, t))

ã§ã€Œå‹ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆType mismatchï¼‰ã€ã‚„ã€Œå¼•æ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€ã¨å‡ºã‚‹å ´åˆã€**ã»ã¼ç¢ºå®Ÿã« arr ãŒâ€œ2æ¬¡å…ƒé…åˆ—ã§ã¯ãªã„â€ã‹ã€Map_SrcCols(i, t) ãŒå¤‰ãªå€¤ï¼ˆç©ºã€ã‚¨ãƒ©ãƒ¼å€¤ï¼‰**ã«ãªã£ã¦ã„ã¾ã™ã€‚å…¸å‹åŸå› ã¯ã“ã®ã‚ãŸã‚Šã§ã™ğŸ‘‡

ã‚ˆãã‚ã‚‹åŸå› ãƒã‚§ãƒƒã‚¯
	1.	Mapping ã®ãƒ˜ãƒƒãƒ€ï¼ˆI1ä»¥é™ã®ãƒ†ãƒ¼ãƒ–ãƒ«åï¼‰ â‰  CSVãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­é™¤ãï¼‰
ã€€ä¾‹ï¼‰Mapping ã§ã¯ã€Œåœ¨åº«ã€ãªã®ã«å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ãŒ zaiko.csvã€‚
ã€€â†’ LoadAllCsv ã¯ã€ŒI1ä»¥é™ã«æ›¸ã„ãŸå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚åå‰ãŒ1æ–‡å­—ã§ã‚‚é•ã†ã¨ TableData("åœ¨åº«") ãŒå­˜åœ¨ã›ãšã€arr ãŒé…åˆ—ã§ãªããªã‚Šå¾—ã¾ã™ã€‚
	2.	ã‚­ãƒ¼ã«â—‹ãŒä»˜ã„ã¦ã„ã‚‹ã®ã«ã€ãã®ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—ãŒç©ºæ¬„
ã€€ä¾‹ï¼‰ã‚­ãƒ¼åˆ—è¡Œã«â—‹ã€ã§ã‚‚ Iåˆ—ï¼ˆåœ¨åº«ï¼‰ã‚»ãƒ«ãŒç©ºç™½ã€‚
ã€€â†’ ãã®æ¡ä»¶ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹æƒ³å®šã§ã™ãŒã€Mappingã®ãšã‚Œã§ç•°å¸¸å€¤ãŒæ¥ã‚‹ã¨å¤±æ•—ã—ã‚„ã™ã„ã§ã™ã€‚
	3.	CSVã®1è¡Œç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ãŒç©º/å´©ã‚Œã¦ã„ã‚‹
ã€€â†’ FindColumnIndex ã¯ã€Œé…åˆ—ã®1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã€ã¨ã—ã¦æ¢ã—ã¾ã™ã€‚ç©ºã ã¨è¦‹ã¤ã‹ã‚‰ãšã€å¾Œç¶šã§æ··ä¹±ã—ã¾ã™ã€‚
	4.	åŠè§’/å…¨è§’ãƒ»ä½™åˆ†ãªã‚¹ãƒšãƒ¼ã‚¹
ã€€ä¾‹ï¼‰"åœ¨åº«id" ã¨ "åœ¨åº«ID"ã€" product_id "ï¼ˆå‰å¾Œã‚¹ãƒšãƒ¼ã‚¹ï¼‰ãªã©ã€‚
ã€€â†’ Mapping ã®åˆ—åã¨ CSV ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯å®Œå…¨ä¸€è‡´ãŒå¿…è¦ã§ã™ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚‚ä¸€è‡´å‰æï¼‰ã€‚
	5.	Mapping ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—æ•°ãƒ»ç©ºè¡Œ
ã€€â†’ ãƒ†ãƒ¼ãƒ–ãƒ«æœ€çµ‚è¡Œã«ä¸­é€”åŠç«¯ãªã€Œâ—‹ã ã‘å…¥ã£ãŸè¡Œã€ãªã©ãŒã‚ã‚‹ã¨æƒ³å®šå¤–ã«ãªã‚Šã¾ã™ã€‚

â¸»

ã¨ã‚Šã‚ãˆãšè½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹â€œå …ç‰¢åŒ–ãƒ‘ãƒƒãƒâ€

modMappingHelper ã® BuildKeyIndexes ã‚’ã€å®‰å…¨ç¢ºèªï¼‹ãƒ­ã‚°ã‚’åšãã—ãŸç‰ˆã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼ˆä¸‹è¨˜ä¸¸ã”ã¨ç½®æ›ï¼‰ã€‚
ã€Œé…åˆ—ã‹ï¼Ÿã€ã€Œå…ƒåˆ—åã¯ç©ºã§ãªã„ã‹ï¼Ÿã€ã€Œåˆ—ãŒè¦‹ã¤ã‹ã£ãŸã‹ï¼Ÿã€ã‚’éƒ½åº¦ãƒã‚§ãƒƒã‚¯ã—ã€å•é¡ŒãŒã‚ã‚Œã°ãƒ­ã‚°ã«è­¦å‘Šã‚’å‡ºã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

'==============================
' ã‚­ãƒ¼ç´¢å¼•ï¼ˆSingle: 1ä»¶ã€Multi: è¤‡æ•°è¡Œï¼‰å …ç‰¢ç‰ˆ
'==============================
Public Sub BuildKeyIndexes()
    Set KeyIndexSingle = CreateObject("Scripting.Dictionary")
    Set KeyIndexMulti  = CreateObject("Scripting.Dictionary")
    
    Dim t As Long
    If (Not Not Map_TblNames) = 0 Then Exit Sub
    
    For t = LBound(Map_TblNames) To UBound(Map_TblNames)
        Dim tblName As String: tblName = Map_TblNames(t)
        Dim arr As Variant
        
        ' 1) ãƒ†ãƒ¼ãƒ–ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
        If Not TableData.Exists(tblName) Then
            WriteLog "ERROR", "BuildKeyIndexes: table not loaded: " & tblName
            ' ç©ºã®è¾æ›¸ã§ã‚‚å…¥ã‚Œã¦ãŠã
            KeyIndexSingle(tblName) = CreateObject("Scripting.Dictionary")
            KeyIndexMulti(tblName)  = CreateObject("Scripting.Dictionary")
            GoTo CONT_T
        End If
        
        arr = TableData(tblName)
        ' 2) é…åˆ—ã§ã€ã‹ã¤2æ¬¡å…ƒã‹ï¼Ÿ
        If Not IsArray(arr) Then
            WriteLog "ERROR", "BuildKeyIndexes: table is not array: " & tblName
            KeyIndexSingle(tblName) = CreateObject("Scripting.Dictionary")
            KeyIndexMulti(tblName)  = CreateObject("Scripting.Dictionary")
            GoTo CONT_T
        End If
        On Error GoTo BAD_ARRAY
        Dim rUB1 As Long, rUB2 As Long
        rUB1 = UBound(arr, 1): rUB2 = UBound(arr, 2)
        On Error GoTo 0
        If rUB1 < 2 Or rUB2 < 1 Then
            WriteLog "ERROR", "BuildKeyIndexes: invalid array shape: " & tblName
            KeyIndexSingle(tblName) = CreateObject("Scripting.Dictionary")
            KeyIndexMulti(tblName)  = CreateObject("Scripting.Dictionary")
            GoTo CONT_T
        End If
        
        ' 3) ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ä½¿ã†ã‚­ãƒ¼åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä½ç½®ã‚’é›†ã‚ã‚‹
        Dim keyColIdx() As Long, kc As Long: kc = 0
        Dim i As Long
        For i = LBound(Map_IsKey) To UBound(Map_IsKey)
            If Map_IsKey(i) Then
                If UBound(Map_SrcCols, 2) >= t Then
                    Dim srcCol As String: srcCol = Trim$(CStr(Map_SrcCols(i, t)))
                    If Len(srcCol) > 0 Then
                        Dim idx As Long
                        idx = FindColumnIndex(arr, srcCol)
                        If idx > 0 Then
                            kc = kc + 1
                            ReDim Preserve keyColIdx(1 To kc)
                            keyColIdx(kc) = idx
                        Else
                            WriteLog "WARN", "BuildKeyIndexes: key column not found. table=" & tblName & " col=" & srcCol
                        End If
                    Else
                        ' ã‚­ãƒ¼ã«â—‹ã ãŒã€ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…ƒåˆ—ãŒç©º â†’ ã‚¹ã‚­ãƒƒãƒ—
                    End If
                End If
            End If
        Next
        
        Dim dict1 As Object, dictM As Object
        Set dict1 = CreateObject("Scripting.Dictionary")
        Set dictM = CreateObject("Scripting.Dictionary")
        
        ' 4) å®Ÿéš›ã«ã‚­ãƒ¼ã‚’ä½œã‚‹
        If kc > 0 Then
            Dim r As Long, keyStr As String
            For r = 2 To rUB1
                keyStr = BuildKeyFromRow(arr, r, keyColIdx)
                If Len(keyStr) > 0 Then
                    If Not dict1.Exists(keyStr) Then dict1.Add keyStr, r
                    If Not dictM.Exists(keyStr) Then dictM.Add keyStr, New Collection
                    dictM(keyStr).Add r
                End If
            Next
        Else
            WriteLog "WARN", "BuildKeyIndexes: no key columns collected for table=" & tblName
        End If
        
        KeyIndexSingle(tblName) = dict1
        KeyIndexMulti(tblName)  = dictM
        
CONT_T:
        ' æ¬¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¸
    Next
    Exit Sub

BAD_ARRAY:
    On Error GoTo 0
    WriteLog "ERROR", "BuildKeyIndexes: UBound failed (not 2D array?) table=" & Map_TblNames(t)
    KeyIndexSingle(Map_TblNames(t)) = CreateObject("Scripting.Dictionary")
    KeyIndexMulti(Map_TblNames(t))  = CreateObject("Scripting.Dictionary")
End Sub

åŠ ãˆã¦ã€FindColumnIndex ã‚‚ â€œãƒ˜ãƒƒãƒ€ãƒ¼æ¯”è¼ƒã®å‰å¾Œã‚¹ãƒšãƒ¼ã‚¹ã‚’ç„¡è¦–â€ ã§ãã‚‹ã‚ˆã†å°‘ã—ã ã‘å¼·åŒ–ã—ã¦ãŠãã¨ã€èª¤å·®ã‚’æ‹¾ã„ã«ãããªã‚Šã¾ã™ã€‚

Public Function FindColumnIndex(arr As Variant, colName As String) As Long
    Dim c As Long, target As String
    target = Trim$(CStr(colName))
    For c = 1 To UBound(arr, 2)
        If Trim$(CStr(arr(1, c))) = target Then
            FindColumnIndex = c
            Exit Function
        End If
    Next
    FindColumnIndex = 0
End Function


â¸»

ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã¨ãã®æœ€çŸ­åˆ‡ã‚Šåˆ†ã‘
	â€¢	ã‚¤ãƒ³ãƒãƒ¼ãƒˆç›´å¾Œã«ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã®ãƒ†ãƒ¼ãƒ–ãƒ«å ã¨ å®Ÿãƒ•ã‚¡ã‚¤ãƒ« ã‚’ç…§åˆã—ã¦ãã ã•ã„ã€‚
ä¾‹ï¼‰I1="zaiko" â†’ importFiles\zaiko.csv ãŒã‚ã‚‹ã‹ï¼Ÿ
	â€¢	è©²å½“ãƒ†ãƒ¼ãƒ–ãƒ«ã® CSV ã‚’é–‹ãã€1è¡Œç›®ã®è¦‹å‡ºã— ãŒ Mapping ã§æŒ‡å®šã—ãŸã€Œå…ƒã‚«ãƒ©ãƒ åã€ã¨å®Œå…¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã€‚
	â€¢	ã‚¨ãƒ©ãƒ¼å†ç¾æ™‚ã«ã€Immediate ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆCtrl+Gï¼‰ã§ãƒ­ã‚°ã‚’è¦‹ã¦ã€
BuildKeyIndexes: key column not found. table=... col=... ã®è­¦å‘ŠãŒå‡ºã¦ã„ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã€‚

â¸»

å¿…è¦ãªã‚‰ã€Mapping ã®è©²å½“è¡Œï¼ˆNo / å‡ºåŠ›ã‚«ãƒ©ãƒ å / ã‚­ãƒ¼ / ãƒ†ãƒ¼ãƒ–ãƒ«ååˆ—â€¦ï¼‰ã®ã‚¹ã‚¯ã‚·ãƒ§ or å€¤ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ãã“ã«åˆã‚ã›ã¦æœ€çŸ­ã§ç›´ã—ã¾ã™ï¼