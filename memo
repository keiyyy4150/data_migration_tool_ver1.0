「この範囲は既存のテーブルと整合していないため、機能しません。テーブルには同一の行の見出しが必要であり、１行以上のデータが含まれている必要があります。また、新しい範囲は既存のテーブルと重なっている必要があります」のエラーが出る


'==============================
' 高速クリア：Masterを空に＆中間データ解放
'==============================
Public Sub ClearData()
    Dim prevCalc As XlCalculation
    Dim prevUpd As Boolean, prevEvt As Boolean, prevDisp As Boolean
    Dim masterLo As ListObject
    Dim t0 As Double: t0 = Timer
    
    On Error Resume Next
    ' 現在のアプリ状態を退避
    prevUpd = Application.ScreenUpdating
    prevEvt = Application.EnableEvents
    prevDisp = Application.DisplayAlerts
    prevCalc = Application.Calculation
    ' 速度アップ用フラグをOFF
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual
    On Error GoTo 0
    
    On Error GoTo EH
    
    ' --- Master テーブルを取得（シート名＋テーブル名で安定取得） ---
    Set masterLo = GetListObjectByName(CurrentMasterTableName)
    If Not masterLo Is Nothing Then
        ' フィルタが掛かっていると削除時に遅いことがある → 全表示
        On Error Resume Next
        If masterLo.AutoFilter Is Nothing Then
        Else
            masterLo.AutoFilter.ShowAllData
        End If
        On Error GoTo 0
        
        ' ★最速：ヘッダだけにリサイズして一発で空にする（書式・列構成は保持）
        masterLo.Resize masterLo.HeaderRowRange
    End If
    
    ' --- 中間の状態フラグとメモリを解放 ---
    HasRaw = False
    IsProcessed = False
    
    ' 大きな配列は Erase（未初期化でも安全に呼べるようエラートラップ）
    On Error Resume Next
    If Not (IsEmpty(RawJoined)) Then Erase RawJoined
    If Not (IsEmpty(m_baseRowIdx)) Then Erase m_baseRowIdx
    On Error GoTo 0
    
    m_baseTblName = ""
    
    ' Dictionary や参照を解放（Set = Nothing は O(1) で速い）
    Set TableData = Nothing
    Set KeyIndexSingle = Nothing
    Set KeyIndexMulti = Nothing
    
    ' ログ（I/Oも最小限に）
    WriteLog "INFO", "ClearData: Master cleared & memory freed in " & Format(Timer - t0, "0.00") & "s"
    
DONE:
    ' --- アプリ状態を元に戻す ---
    On Error Resume Next
    Application.ScreenUpdating = prevUpd
    Application.EnableEvents = prevEvt
    Application.DisplayAlerts = prevDisp
    Application.Calculation = prevCalc
    On Error GoTo 0
    
    MsgBox "初期化しました。", vbInformation
    Exit Sub

EH:
    ' 例外が出てもアプリ状態は必ず戻す
    On Error Resume Next
    Application.ScreenUpdating = prevUpd
    Application.EnableEvents = prevEvt
    Application.DisplayAlerts = prevDisp
    Application.Calculation = prevCalc
    On Error GoTo 0
    
    WriteLog "ERROR", "ClearData error: " & Err.Number & " " & Err.Description
    MsgBox "ClearDataでエラー: " & Err.Description, vbCritical
End Sub
