Option Explicit

'======================================================
' Mappingテーブル取得 / 読み取り
'======================================================

'--- テーブル名から ListObject を取得（同名シート優先→全シート検索） ---
Public Function GetTableByName(tblName As String) As ListObject
    Dim ws As Worksheet, lo As ListObject
    On Error Resume Next
    Set lo = ThisWorkbook.Sheets(tblName).ListObjects(tblName)
    On Error GoTo 0
    If Not lo Is Nothing Then
        Set GetTableByName = lo
        Exit Function
    End If
    For Each ws In ThisWorkbook.Worksheets
        For Each lo In ws.ListObjects
            If StrComp(lo.Name, tblName, vbTextCompare) = 0 Then
                Set GetTableByName = lo
                Exit Function
            End If
        Next lo
    Next ws
End Function

'--- Mappingテーブルを読み→グローバルキャッシュへ展開 ---
Public Function ReadMappingFromTableName(mappingTblName As String) As Boolean
    On Error GoTo FAIL
    Dim mapTbl As ListObject, lastRow As Long, lastCol As Long
    Set mapTbl = GetTableByName(mappingTblName)
    If mapTbl Is Nothing Then
        MsgBox "Mappingテーブル '" & mappingTblName & "' が見つかりません。", vbCritical
        ReadMappingFromTableName = False
        Exit Function
    End If

    Dim hdr As Range, body As Range
    Set hdr = mapTbl.HeaderRowRange
    Set body = mapTbl.DataBodyRange
    If body Is Nothing Then
        ReadMappingFromTableName = False
        Exit Function
    End If

    Dim rCount As Long, cCount As Long
    rCount = body.Rows.Count
    cCount = hdr.Columns.Count

    ' A〜G（固定7列）を読む
    ReDim Map_OutCols(1 To rCount)
    ReDim Map_DataType(1 To rCount)
    ReDim Map_Logic(1 To rCount)
    ReDim Map_IsKey(1 To rCount)
    ReDim Map_Mode(1 To rCount)
    ReDim Map_Def(1 To rCount)

    Dim r As Long, c As Long
    For r = 1 To rCount
        Map_OutCols(r)  = CStr(body.Cells(r, 2).Value) ' B: 出力カラム名
        Map_DataType(r) = UCase$(Trim$(CStr(body.Cells(r, 3).Value))) ' C: 型
        Map_Logic(r)    = CStr(body.Cells(r, 4).Value) ' D: ロジック
        Map_IsKey(r)    = (CStr(body.Cells(r, 5).Value) = "○") ' E: キー
        Map_Mode(r)     = UCase$(Trim$(CStr(body.Cells(r, 6).Value))) ' F: モード
        If Len(Map_Mode(r)) = 0 Then Map_Mode(r) = "VALUE"
        Map_Def(r)      = CStr(body.Cells(r, 7).Value) ' G: 定義
    Next r

    ' H以降：テーブル名（1行目ヘッダ）を取り、各行の対応カラム名を読む
    Dim tCount As Long
    tCount = Application.Max(0, cCount - 7)
    If tCount > 0 Then
        ReDim Map_TblNames(0 To tCount - 1)
        For c = 8 To 7 + tCount
            Map_TblNames(c - 8) = CStr(hdr.Cells(1, c).Value)
        Next c

        ReDim Map_SrcCols(1 To rCount, 0 To tCount - 1)
        For r = 1 To rCount
            For c = 0 To tCount - 1
                Map_SrcCols(r, c) = CStr(body.Cells(r, 8 + c).Value)
            Next c
        Next r
    Else
        ReDim Map_TblNames(0 To -1) ' 空
        ReDim Map_SrcCols(1 To 1, 0 To 0)
    End If

    ReadMappingFromTableName = True
    Exit Function
FAIL:
    ReadMappingFromTableName = False
End Function